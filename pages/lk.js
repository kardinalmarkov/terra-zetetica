// pages/lk.js
import Head        from 'next/head'
import Link        from 'next/link'
import { parse }   from 'cookie'
import { useRouter } from 'next/router'
import { useState, useEffect } from 'react'
import ClipLoader  from 'react-spinners/ClipLoader'
import DayPicker   from '../components/DayPicker'
import { supabase } from '../lib/supabase'

function Tabs({ tabs, active, onChange }) {
  return (
    <nav style={{display:'flex', gap:12, marginBottom:18}}>
      {tabs.map(t => (
        <button
          key={t.key}
          onClick={()=>onChange(t.key)}
          style={{
            padding:'.5rem .9rem',
            borderRadius:6,
            border: active===t.key ? '2px solid #6c63ff' : '1px solid #ccc',
            background: active===t.key ? '#f0f0ff' : '#fff',
            cursor:'pointer'
          }}>
          {t.label}
        </button>
      ))}
    </nav>
  )
}

export default function LK({ user }) {
  const router = useRouter()
  const [citizen, setCitizen]   = useState()
  const [progress, setProgress] = useState(0)
  const [notesMap, setNotesMap] = useState({})
  const [tab, setTab]           = useState('profile')

  // –≤—ã—Ö–æ–¥
  async function logout() {
    await fetch('/api/logout', { method:'POST' })
    router.replace('/')
  }

  // 0) –µ—Å–ª–∏ –Ω–µ—Ç tg-cookie ‚Äî Telegram-–≤–∏–¥–∂–µ—Ç
  if (!user) {
    return (
      <main style={{padding:'2rem', maxWidth:600,margin:'0 auto'}}>
        <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <p>–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram:</p>
        <div dangerouslySetInnerHTML={{__html:`
<script async src="https://telegram.org/js/telegram-widget.js?15"
        data-telegram-login="ZeteticID_bot"
        data-size="large"
        data-userpic="true"
        data-lang="ru"
        data-request-access="write"
        data-auth-url="/api/auth"></script>`}}/>
      </main>
    )
  }

  // 1) –ø–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å citizen
  useEffect(()=>{
    supabase
      .from('citizens')
      .select('*').eq('telegram_id', user.id).maybeSingle()
      .then(({ data }) => setCitizen(data ?? null))
  },[user])

  // 2) –ø—Ä–æ–≥—Ä–µ—Å—Å
  useEffect(()=>{
    if (!citizen?.id) return
    supabase
      .from('daily_progress')
      .select('*',{ head:true, count:'exact' })
      .eq('citizen_id', citizen.id)
      .then(({ count }) => setProgress(count||0))
  },[citizen])

  // 3) –∑–∞–º–µ—Ç–∫–∏ –ø–æ –¥–Ω—è–º
  useEffect(()=>{
    if (!citizen?.id) return
    supabase
      .from('daily_progress')
      .select('day_no,notes')
      .eq('citizen_id', citizen.id)
      .then(({ data })=>{
        const m = {}
        data.forEach(r=> { if (r.notes) m[r.day_no] = r.notes })
        setNotesMap(m)
      })
  },[citizen])

  // —Å—Ç–∞—Ç—É—Å –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–∞
  function renderStatus() {
    if (!citizen)               return '‚úñ –ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ'
    if (citizen.status==='valid') return '‚úÖ –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω Terra Zetetica'
    return '‚ùì –í –æ–±—Ä–∞–±–æ—Ç–∫–µ'
  }

  // 1) –∂–¥—ë–º Supabase
  if (citizen === undefined) {
    return <main style={{padding:'2rem', textAlign:'center'}}><ClipLoader size={40} color="#6c63ff"/></main>
  }

  // 2) –æ—Å–Ω–æ–≤–Ω–æ–π UI
  return (
    <>
      <Head><title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Ä¢ Terra Zetetica</title></Head>
      <main style={{maxWidth:800, margin:'0 auto', padding:'2rem'}}>

        <header style={{display:'flex', justifyContent:'space-between', marginBottom:20}}>
          <strong>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user.first_name}!</strong>
          <button onClick={logout} className="btn-secondary">–í—ã–π—Ç–∏</button>
        </header>

        <Tabs
          active={tab}
          onChange={setTab}
          tabs={[
            {key:'profile',  label:'üôè –ü—Ä–æ—Ñ–∏–ª—å'},
            {key:'passport', label:'üìú –ü–∞—Å–ø–æ—Ä—Ç / üè† –ß–µ–ª–ª–µ–Ω–¥–∂'},
            {key:'progress', label:'üìà –ü—Ä–æ–≥—Ä–µ—Å—Å'},
          ]}
        />

        {tab==='profile' && (
          <section>
            <img src={user.photo_url} alt="avatar" width={120} height={120} style={{borderRadius:8}}/>
            <p>ID Telegram: <b>{user.id}</b></p>
            {user.username && <p>Username: <b>@{user.username}</b></p>}
            <p><b>–ó–∞–ø–∏—Å—å –≤ –ë–î:</b> {citizen ? '‚úîÔ∏è –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç'}</p>
            <p><b>–°—Ç–∞—Ç—É—Å:</b> {renderStatus()}</p>
          </section>
        )}

        {tab==='passport' && (
          <section>
            {citizen
              ? <>
                  <p>Z-ID: <b>{citizen.zetetic_id||'‚Äî'}</b></p>
                  <p>IPFS Passport: {citizen.ipfs_url
                    ? <a href={citizen.ipfs_url} target="_blank">—Å—Å—ã–ª–∫–∞</a>
                    : '‚Äî'}
                  </p>
                  <p>Challenge: <b>{citizen.challenge_status||'‚Äî'}</b></p>
                </>
              : <p>–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å.</p>
            }
          </section>
        )}

        {tab==='progress' && (
          <section>
            <p>–î–Ω–µ–π –ø—Ä–æ–π–¥–µ–Ω–æ: <b>{progress}</b> / 14</p>
            <div style={{background:'#eee',height:12, borderRadius:6, maxWidth:400}}>
              <div style={{
                width:`${(progress/14)*100}%`,
                height:'100%',
                background:'#6c63ff',
                borderRadius:6
              }}/>
            </div>

            {progress===0 && (
              <p style={{opacity:0.7, marginTop:12}}>
                –ù–∞–∂–º–∏—Ç–µ <Link href="/dom">¬´–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è¬ª</Link>, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å.
              </p>
            )}

            {progress>0 && (
              <>
                <p style={{marginTop:12}}>
                  ‚Ü©Ô∏è <Link href={`/challenge?day=${progress}`}>–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–Ω—å {progress}</Link>
                </p>
                <DayPicker
                  currentDay={progress}
                  maxDay={progress}
                  onChange={n=>router.push(`/challenge?day=${n}`)}
                />
              </>
            )}

            {progress>0 && (
              <section style={{marginTop:24}}>
                <h4>–ó–∞–º–µ—Ç–∫–∏ –ø–æ –¥–Ω—è–º</h4>
                <ul>
                  {Array.from({length:progress}).map((_,i)=>(
                    <li key={i}>
                      –î–µ–Ω—å {i+1}: <i>{notesMap[i+1]||'‚Äì –Ω–µ—Ç ‚Äì'}</i>
                    </li>
                  ))}
                </ul>
              </section>
            )}
          </section>
        )}

      </main>
    </>
  )
}

export async function getServerSideProps({ req }) {
  const { tg } = parse(req.headers.cookie||'')
  const user = tg ? JSON.parse(Buffer.from(tg,'base64').toString()) : null
  return { props:{ user } }
}
